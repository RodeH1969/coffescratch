<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Coffee Spin</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜•</text></svg>">
<style>
:root { --gold: #ffd700; }
body {
  margin: 0; padding: 20px;
  background: linear-gradient(135deg, #1e3c72, #2a5298);
  font-family: Arial, sans-serif;
  display: flex; justify-content: center; align-items: center;
  min-height: 100vh; color: #fff;
}
.slot-machine {
  background: linear-gradient(145deg, #444, #222);
  border-radius: 20px; padding: 24px; text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.4);
  border: 3px solid var(--gold);
  max-width: 560px; width: 100%;
}
.logo {
  width: 180px; max-width: 70%; height: auto;
  display: block; margin: 0 auto 10px auto;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,0.45));
}
.status { min-height: 44px; font-size: 1.05rem; margin: 8px 0 6px; }

.slots-container {
  display: flex; justify-content: center; gap: 14px;
  margin: 12px 0 8px; background: #111; padding: 12px;
  border-radius: 15px; border: 3px solid var(--gold); position: relative;
}
.slot {
  width: 92px; height: 110px; background: #333;
  border: 3px solid #555; border-radius: 10px;
  overflow: hidden; box-shadow: inset 0 4px 8px rgba(0,0,0,0.3);
}
.slot img {
  width: 100%; height: auto; display: block;
}

/* Reel spin animation */
@keyframes spin {
  0% { transform: translateY(0); }
  100% { transform: translateY(-300%); }
}
.reel {
  animation: spin 0.5s linear infinite;
}

.spin-button {
  background: linear-gradient(145deg, var(--gold), #ffa000);
  border: none; border-radius: 50%; width: 140px; height: 70px;
  font-size: 1.1rem; font-weight: bold; color: #333; cursor: pointer;
  box-shadow: 0 8px 16px rgba(0,0,0,0.3); transition: all 0.2s ease;
  margin: 10px auto 6px; display: inline-flex; align-items: center; justify-content: center;
}
.spin-button:hover { transform: translateY(-2px); }
.spin-button:disabled { background: #666; color: #ddd; cursor: not-allowed; box-shadow: none; }

.win-box {
  margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.4);
  border: 1px solid var(--gold); border-radius: 10px; display: none;
}
.win-box h3 { margin: 0 0 8px 0; color: var(--gold); }
.qr-wrap { display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap; }
.qr-note { font-size: 0.95rem; opacity: 0.9; }

.paramount-ad { margin-top: 18px; text-align: center; }
.paramount-ad img {
  max-width: 100%; height: auto; border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
</style>
</head>
<body>
<div class="slot-machine">
  <img class="logo" src="assets/coffeespinlogo.png" alt="Coffee Spin Logo" />

  <div id="status" class="status">Loading tokenâ€¦</div>

  <div class="slots-container">
    <div class="slot" id="slot1"><img id="img1" src="assets/ad1.png"></div>
    <div class="slot" id="slot2"><img id="img2" src="assets/ad2.png"></div>
    <div class="slot" id="slot3"><img id="img3" src="assets/ad3.png"></div>
  </div>

  <button class="spin-button" id="spinButton" disabled>SPIN</button>

  <div id="winBox" class="win-box">
    <h3>ðŸŽ‰ Winner! Free coffee</h3>
    <div class="qr-wrap">
      <canvas id="qrCanvas" width="120" height="120"></canvas>
      <div class="qr-note">
        Show this QR code to your barista to get your free coffee!<br/>
        Token: <span id="tokenText"></span>
      </div>
    </div>
  </div>

  <div class="paramount-ad">
    <a href="https://www.paramountplus.com/au/" target="_blank" rel="noopener">
      <img src="assets/paramountplusad.png" alt="Paramount+ Advertisement">
    </a>
  </div>

  <audio id="spinAudio" preload="auto">
    <source src="assets/spin.mp3" type="audio/mpeg" />
  </audio>
  <audio id="winnerAudio" preload="auto">
    <source src="assets/winner.mp3" type="audio/mpeg" />
  </audio>
</div>

<script src="/assets/qrious.min.js"></script>
<script>
const API_BASE = window.location.origin;
const imgs = [document.getElementById('img1'), document.getElementById('img2'), document.getElementById('img3')];
const spinBtn = document.getElementById('spinButton');
const statusEl = document.getElementById('status');
const spinAudio = document.getElementById('spinAudio');
const winAudio = document.getElementById('winnerAudio');
const winBox = document.getElementById('winBox');
const qrCanvas = document.getElementById('qrCanvas');
const tokenText = document.getElementById('tokenText');

let token = null;
let tokenResult = null;

async function init() {
  const params = new URLSearchParams(window.location.search);
  token = params.get('token');
  if (!token) { statusEl.textContent = 'âŒ Missing token.'; return; }

  statusEl.textContent = 'Checking tokenâ€¦';
  try {
    const res = await fetch(`${API_BASE}/api/token/${encodeURIComponent(token)}`);
    const data = await res.json();
    if (!data.valid) { statusEl.textContent = 'âŒ Invalid token.'; return; }
    tokenResult = data.result;
    statusEl.textContent = '';
    spinBtn.disabled = false;
  } catch (e) {
    statusEl.textContent = 'âŒ Server error.';
  }
}

function startSpin() {
  spinBtn.disabled = true;
  imgs.forEach(img => { img.classList.add('reel'); });
  spinAudio.play();

  setTimeout(() => {
    imgs.forEach(img => { img.classList.remove('reel'); });
    if (tokenResult === 'win') {
      imgs.forEach(img => img.src = 'assets/tick.png');
      winAudio.play();
      const verifyURL = `${API_BASE}/verify.html?token=${encodeURIComponent(token)}`;
      tokenText.textContent = token;
      new QRious({ element: qrCanvas, size: 120, value: verifyURL });
      winBox.style.display = 'block';
    } else {
      imgs.forEach(img => img.src = 'assets/cross.png');
      statusEl.textContent = 'ðŸ˜¢ Oh shucks, not a winner today. Come back soon for another spin!';
    }
  }, 2000);
}

spinBtn.addEventListener('click', startSpin);
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
