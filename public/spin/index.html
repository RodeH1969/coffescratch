<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Coffee Spin</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☕</text></svg>">
  <style>
    :root { --gold: #ffd700; }
    body {
      margin: 0; padding: 20px;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      font-family: Arial, sans-serif;
      display: flex; justify-content: center; align-items: flex-start;
      min-height: 100vh; color: #fff;
    }
    .slot-machine {
      background: linear-gradient(145deg, #444, #222);
      border-radius: 20px; padding: 24px; text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border: 3px solid var(--gold);
      max-width: 560px; width: 100%;
      margin-top: 20px;
    }
    /* 25% smaller logo */
    .logo {
      width: 180px;
      max-width: 70%;
      height: auto;
      display: block;
      margin: 0 auto 10px auto;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.45));
    }

    .status { min-height: 24px; font-size: 1.05rem; margin: 6px 0; }

    .slots-container {
      display: flex; justify-content: center; gap: 14px;
      margin: 8px 0; background: #111; padding: 12px;
      border-radius: 15px; border: 3px solid var(--gold); position: relative;
    }
    .slot {
      width: 92px; height: 110px; background: #333;
      border: 3px solid #555; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
      box-shadow: inset 0 4px 8px rgba(0,0,0,0.3);
    }
    .slot img {
      width: 100%; height: 100%; object-fit: cover;
      transform-origin: center;
      will-change: contents;
      user-select: none;
      pointer-events: none;
    }

    /* Final text replaces ads after spin */
    .final-text {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      letter-spacing: 1px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
      user-select: none;
    }
    .final-text.win { display: flex; color: #00ff9c; font-size: 32px; }
    .final-text.lose { display: flex; color: #ff6b6b; font-size: 28px; }

    /* Capsule spin button */
    .spin-button {
      background: linear-gradient(145deg, var(--gold), #ffa000);
      border: none; border-radius: 999px;
      width: 180px; height: 60px;
      font-size: 1.1rem; font-weight: bold; color: #333; cursor: pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3); transition: all 0.2s ease;
      margin: 14px auto 6px; display: inline-flex; align-items: center; justify-content: center;
    }
    .spin-button:hover { transform: translateY(-2px); }
    .spin-button:active { transform: translateY(0); }
    .spin-button:disabled { background: #666; color: #ddd; cursor: not-allowed; box-shadow: none; }

    .win-box {
      margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.4);
      border: 1px solid var(--gold); border-radius: 10px; display: none;
    }
    .win-box h3 { margin: 0 0 8px 0; color: var(--gold); }
    .qr-wrap { display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap; }
    .qr-note { font-size: 0.95rem; opacity: 0.9; }

    .paramount-ad { margin-top: 18px; text-align: center; }
    .paramount-ad img {
      max-width: 100%; height: auto; border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .tiny { opacity: 0.85; font-size: 0.85rem; margin-top: 8px; }

    @media (max-width: 420px) {
      body { align-items: flex-start; padding-top: 5px; }
      .slot-machine { margin-top: 5px; }
      .slot { width: 82px; height: 100px; }
      .spin-button { width: 160px; height: 55px; }
      .final-text.win { font-size: 28px; }
      .final-text.lose { font-size: 24px; }
      .logo { width: 150px; }
    }
  </style>
</head>
<body>
  <div class="slot-machine">
    <img class="logo" src="assets/coffeespinlogo.png" alt="Coffee Spin Logo" />

    <div id="status" class="status"></div>

    <div class="slots-container">
      <div class="slot" id="slot1">
        <img id="img1" src="assets/ad1.png" alt="Ad 1">
        <div class="final-text" id="final1"></div>
      </div>
      <div class="slot" id="slot2">
        <img id="img2" src="assets/ad2.png" alt="Ad 2">
        <div class="final-text" id="final2"></div>
      </div>
      <div class="slot" id="slot3">
        <img id="img3" src="assets/ad3.png" alt="Ad 3">
        <div class="final-text" id="final3"></div>
      </div>
    </div>

    <button class="spin-button" id="spinButton" disabled>SPIN</button>

    <!-- Winner reveal / QR -->
    <div id="winBox" class="win-box">
      <h3>🎉 Winner! Free coffee</h3>
      <div class="qr-wrap">
        <canvas id="qrCanvas" width="120" height="120" style="display:none;"></canvas>
        <div class="qr-note">
          Token: <span id="tokenText"></span><br/>
          <span id="qrFallback" class="tiny" style="display:none;">(QR not available — show this token to barista)</span>
        </div>
      </div>
      <div class="tiny">Show this QR code to your barista to get your free coffee!</div>
    </div>

    <div class="paramount-ad">
      <a href="https://www.paramountplus.com/au/?gclid=a2d84b86af821a952a2523136b29fa69&gclsrc=3p.ds&&ftag=IPP-07-10djc8i&vndid=&msclkid=a2d84b86af821a952a2523136b29fa69"
         target="_blank" rel="noopener">
        <img src="assets/paramountplusad.png" alt="Paramount+ Advertisement">
      </a>
    </div>

    <audio id="spinAudio" preload="auto">
      <source src="assets/spin.mp3" type="audio/mpeg" />
    </audio>
    <audio id="winnerAudio" preload="auto">
      <source src="assets/winner.mp3" type="audio/mpeg" />
    </audio>
  </div>

  <!-- QR lib (fallback-safe) -->
  <script src="/assets/qrious.min.js"></script>

  <script>
    const API_BASE = window.location.origin;

    // Elements
    const imgEls   = [document.getElementById('img1'), document.getElementById('img2'), document.getElementById('img3')];
    const finals   = [document.getElementById('final1'), document.getElementById('final2'), document.getElementById('final3')];
    const spinBtn  = document.getElementById('spinButton');
    const statusEl = document.getElementById('status');
    const spinSnd  = document.getElementById('spinAudio');
    const winSnd   = document.getElementById('winnerAudio');
    const winBox   = document.getElementById('winBox');
    const qrCanvas = document.getElementById('qrCanvas');
    const tokenText= document.getElementById('tokenText');
    const qrFallback = document.getElementById('qrFallback');

    // Reel frames (ads)
    const frames = ["assets/ad1.png", "assets/ad2.png", "assets/ad3.png"];

    // State
    let token = null;
    let tokenResult = null; // 'win' | 'lose'
    let isSpinning = false;

    // Preload images to avoid flicker
    function preload(srcs) {
      srcs.forEach(s => { const i = new Image(); i.src = s; });
    }
    preload(frames);

    // Cubic ease-out for deceleration
    function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

    // Spin a single reel by cycling its img src with easing
    function spinReel(imgEl, durationMs, startOffset = 0) {
      return new Promise(resolve => {
        const start = performance.now() + startOffset;
        let lastIdx = 0;

        function step(now) {
          if (now < start) { requestAnimationFrame(step); return; }
          const elapsed = Math.min(now - start, durationMs);
          const t = elapsed / durationMs;         // 0 → 1
          const speed = 30 + (1 - easeOutCubic(t)) * 250; // px/s-ish metaphor; just for frame pacing

          // Use speed to pick frame index
          // Convert to "frames per second" feel by mapping speed to ~changes per second
          const changesPerSec = speed / 50; // tune denominator to taste
          const frameFloat = Math.floor(elapsed / (1000 / Math.max(8, changesPerSec)));
          const idx = frameFloat % frames.length;

          if (idx !== lastIdx) {
            imgEl.src = frames[idx];
            lastIdx = idx;
          }

          if (elapsed < durationMs) {
            requestAnimationFrame(step);
          } else {
            resolve();
          }
        }
        requestAnimationFrame(step);
      });
    }

    function revealFinals(isWin) {
      // Hide images, show WIN/LOSE text
      imgEls.forEach(img => img.style.display = 'none');
      finals.forEach(el => {
        el.textContent = isWin ? 'WIN' : 'LOSE';
        el.className = 'final-text ' + (isWin ? 'win' : 'lose');
      });
    }

    async function startSpin() {
      if (isSpinning || !tokenResult) return;
      isSpinning = true;
      spinBtn.disabled = true;

      try { spinSnd.currentTime = 0; spinSnd.play(); } catch {}

      // Staggered spin durations (ms) per reel for nicer feel
      const d1 = 1300;  // left reel
      const d2 = 1600;  // middle reel (longer)
      const d3 = 1900;  // right reel (longest)

      // Make sure images are visible while spinning
      imgEls.forEach(img => img.style.display = 'block');
      finals.forEach(el => el.style.display = 'none');

      await Promise.all([
        spinReel(imgEls[0], d1, 0),
        spinReel(imgEls[1], d2, 80),
        spinReel(imgEls[2], d3, 160),
      ]);

      // Stop sound
      try { spinSnd.pause(); spinSnd.currentTime = 0; } catch {}

      const isWin = (tokenResult === 'win');
      revealFinals(isWin);

      if (isWin) {
        try { winSnd.currentTime = 0; winSnd.play(); } catch {}
        tokenText.textContent = token;

        const verifyURL = `${API_BASE}/verify.html?token=${encodeURIComponent(token)}`;
        if (window.QRious) {
          qrCanvas.style.display = 'block';
          new QRious({ element: qrCanvas, size: 120, value: verifyURL });
          qrFallback.style.display = 'none';
        } else {
          qrCanvas.style.display = 'none';
          qrFallback.style.display = 'inline';
        }
        winBox.style.display = 'block';
      } else {
        winBox.style.display = 'none';
      }

      isSpinning = false;
    }

    async function init() {
      const params = new URLSearchParams(window.location.search);
      token = params.get('token');
      if (!token) { statusEl.textContent = '❌ Missing token in URL.'; return; }

      statusEl.textContent = '';
      try {
        const res = await fetch(`${API_BASE}/api/token/${encodeURIComponent(token)}`);
        if (!res.ok) throw new Error('Token not found');
        const data = await res.json();
        if (!data.valid) { statusEl.textContent = '❌ Invalid or expired token.'; return; }
        tokenResult = data.result;
        spinBtn.disabled = false;
      } catch (e) {
        statusEl.textContent = '❌ Error contacting server.';
      }
    }

    spinBtn.addEventListener('click', startSpin);
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
