v<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Coffee Spin</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜•</text></svg>">
  <style>
    :root { --gold: #ffd700; }
    body {
      margin: 0; padding: 20px;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      font-family: Arial, sans-serif;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; color: #fff;
    }
    .slot-machine {
      background: linear-gradient(145deg, #444, #222);
      border-radius: 20px; padding: 24px; text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border: 3px solid var(--gold);
      max-width: 560px; width: 100%;
    }
    .title {
      font-size: 2rem; color: var(--gold); margin-bottom: 12px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-weight: bold;
    }
    .status { min-height: 44px; font-size: 1.05rem; margin: 8px 0 6px; }

    .slots-container {
      display: flex; justify-content: center; gap: 14px;
      margin: 12px 0 8px; background: #111; padding: 12px;
      border-radius: 15px; border: 3px solid var(--gold); position: relative;
    }
    .slot {
      width: 92px; height: 110px; background: #333;
      border: 3px solid #555; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
      box-shadow: inset 0 4px 8px rgba(0,0,0,0.3);
    }
    .slot img {
      width: 100%; height: 100%; object-fit: cover;
      transform-origin: center;
    }
    .slot.spinning img {
      animation: wobble 0.22s ease-in-out infinite;
    }
    @keyframes wobble {
      0% { transform: scale(1.02) rotate(0deg); }
      50% { transform: scale(1.06) rotate(1.5deg); }
      100% { transform: scale(1.02) rotate(0deg); }
    }

    /* Final text that replaces ads after spinning */
    .final-text {
      position: absolute;
      inset: 0;
      display: none;           /* hidden until reveal */
      align-items: center;
      justify-content: center;
      font-weight: 900;
      letter-spacing: 1px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
      user-select: none;
    }
    .final-text.win {
      display: flex;
      color: #00ff9c;
      font-size: 32px;
    }
    .final-text.lose {
      display: flex;
      color: #ff6b6b;
      font-size: 28px;
    }

    .result-banner {
      position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.55); padding: 6px 12px; border-radius: 999px;
      font-weight: bold; border: 2px solid var(--gold); display: none;
    }
    .result-banner.win { background: rgba(40,167,69,0.7); border-color: #8cff8c; }
    .result-banner.lose { background: rgba(220,53,69,0.7); border-color: #ffb3b3; }

    .spin-button {
      background: linear-gradient(145deg, var(--gold), #ffa000);
      border: none; border-radius: 50%; width: 110px; height: 110px;
      font-size: 1.1rem; font-weight: bold; color: #333; cursor: pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3); transition: all 0.2s ease;
      margin: 10px auto 6px; display: inline-flex; align-items: center; justify-content: center;
    }
    .spin-button:hover { transform: translateY(-2px); }
    .spin-button:active { transform: translateY(0); }
    .spin-button:disabled { background: #666; color: #ddd; cursor: not-allowed; box-shadow: none; }

    .win-box {
      margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.4);
      border: 1px solid var(--gold); border-radius: 10px; display: none;
    }
    .win-box h3 { margin: 0 0 8px 0; color: var(--gold); }
    .qr-wrap { display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap; }
    .qr-note { font-size: 0.95rem; opacity: 0.9; }

    .paramount-ad { margin-top: 18px; text-align: center; }
    .paramount-ad img {
      max-width: 100%; height: auto; border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .tiny { opacity: 0.85; font-size: 0.85rem; margin-top: 8px; }

    @media (max-width: 420px) {
      .slot { width: 82px; height: 100px; }
      .spin-button { width: 100px; height: 100px; }
      .final-text.win { font-size: 28px; }
      .final-text.lose { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="slot-machine">
    <h1 class="title">Coffee Spin</h1>

    <div id="status" class="status">Loading tokenâ€¦</div>

    <div class="slots-container">
      <div class="slot" id="slot1">
        <img id="img1" src="assets/ad1.png" alt="Ad 1">
        <div class="final-text" id="final1"></div>
      </div>
      <div class="slot" id="slot2">
        <img id="img2" src="assets/ad2.png" alt="Ad 2">
        <div class="final-text" id="final2"></div>
      </div>
      <div class="slot" id="slot3">
        <img id="img3" src="assets/ad3.png" alt="Ad 3">
        <div class="final-text" id="final3"></div>
      </div>
      <div id="resultBanner" class="result-banner">RESULT</div>
    </div>

    <button class="spin-button" id="spinButton" disabled>SPIN</button>

    <!-- Winner reveal / QR -->
    <div id="winBox" class="win-box">
      <h3>ðŸŽ‰ Winner! Free coffee</h3>
      <div class="qr-wrap">
        <canvas id="qrCanvas" width="120" height="120"></canvas>
        <div class="qr-note">
          Show this to the barista to redeem.<br/>
          Token: <span id="tokenText"></span><br/>
          <a id="verifyLink" href="#" style="color:#ffd700;text-decoration:underline;">Open verify page</a>
        </div>
      </div>
      <div class="tiny">Scanning the QR marks this token as redeemed.</div>
    </div>

    <div class="paramount-ad">
      <a href="https://www.paramountplus.com/au/?gclid=a2d84b86af821a952a2523136b29fa69&gclsrc=3p.ds&&ftag=IPP-07-10djc8i&vndid=&msclkid=a2d84b86af821a952a2523136b29fa69"
         target="_blank" rel="noopener">
        <img src="assets/paramountplusad.png" alt="Paramount+ Advertisement">
      </a>
    </div>

    <audio id="spinAudio" preload="auto">
      <source src="assets/spin.mp3" type="audio/mpeg" />
    </audio>
    <audio id="winnerAudio" preload="auto">
      <source src="assets/winner.mp3" type="audio/mpeg" />
    </audio>
  </div>

  <!-- QR lib (works if /assets/qrious.min.js exists on Render) -->
  <script src="/assets/qrious.min.js"></script>

  <script>
    const API_BASE = window.location.origin; // same-origin (Render)

    const slots = [
      document.getElementById('slot1'),
      document.getElementById('slot2'),
      document.getElementById('slot3')
    ];
    const finals = [
      document.getElementById('final1'),
      document.getElementById('final2'),
      document.getElementById('final3')
    ];
    const imgs = [
      document.getElementById('img1'),
      document.getElementById('img2'),
      document.getElementById('img3')
    ];

    const spinBtn    = document.getElementById('spinButton');
    const statusEl   = document.getElementById('status');
    const spinAudio  = document.getElementById('spinAudio');
    const winAudio   = document.getElementById('winnerAudio');
    const winBox     = document.getElementById('winBox');
    const qrCanvas   = document.getElementById('qrCanvas');
    const tokenText  = document.getElementById('tokenText');
    const verifyLink = document.getElementById('verifyLink');
    const banner     = document.getElementById('resultBanner');

    let isSpinning = false;
    let token = null;
    let tokenResult = null; // 'win' or 'lose'

    async function init() {
      const params = new URLSearchParams(window.location.search);
      token = params.get('token');

      if (!token) {
        statusEl.textContent = 'âŒ Missing token in URL.';
        return;
      }

      statusEl.textContent = 'Checking tokenâ€¦';

      try {
        const res = await fetch(`${API_BASE}/api/token/${encodeURIComponent(token)}`);
        if (!res.ok) throw new Error('Token not found');
        const data = await res.json();

        if (!data.valid) {
          statusEl.textContent = 'âŒ Invalid or expired token.';
          return;
        }

        tokenResult = data.result; // 'win' or 'lose'
        statusEl.textContent = 'Ready. Tap SPIN.';
        spinBtn.disabled = false;

      } catch (e) {
        statusEl.textContent = 'âŒ Error contacting server.';
        console.error(e);
      }
    }

    function revealFinals(asWin) {
      // Hide images and show big text on all three slots
      imgs.forEach(img => img.style.display = 'none');
      finals.forEach(el => {
        el.textContent = asWin ? 'WIN' : 'LOSE';
        el.className = 'final-text ' + (asWin ? 'win' : 'lose');
      });
    }

    function startSpin() {
      if (isSpinning || !tokenResult) return;
      isSpinning = true;
      spinBtn.disabled = true;
      statusEl.textContent = 'Spinningâ€¦';

      try { spinAudio.currentTime = 0; spinAudio.play(); } catch {}

      slots.forEach(s => s.classList.add('spinning'));

      setTimeout(() => {
        slots.forEach(s => s.classList.remove('spinning'));

        const isWin = (tokenResult === 'win');
        revealFinals(isWin);

        banner.style.display = 'block';
        if (isWin) {
          banner.textContent = 'WIN!';
          banner.classList.remove('lose'); banner.classList.add('win');

          statusEl.innerHTML = 'ðŸŽ‰ Winner! Show the QR to the barista.';
          try { winAudio.currentTime = 0; winAudio.play(); } catch {}

          const verifyURL = `${API_BASE}/verify.html?token=${encodeURIComponent(token)}`;
          verifyLink.href = verifyURL;
          tokenText.textContent = token;

          // Render QR (if library loaded)
          if (window.QRious) {
            new QRious({ element: qrCanvas, size: 120, value: verifyURL });
          }
          winBox.style.display = 'block';

        } else {
          banner.textContent = 'LOSE';
          banner.classList.remove('win'); banner.classList.add('lose');
          statusEl.textContent = 'ðŸ˜¢ Not a winner this time.';
          winBox.style.display = 'none';
        }

        isSpinning = false;
      }, 1800);
    }

    spinBtn.addEventListener('click', startSpin);
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
