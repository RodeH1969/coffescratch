<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1"
  />
  <title>Coffee Spin</title>
  <style>
    :root {
      --gold: #ffd700;
    }
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #fff;
    }
    .slot-machine {
      background: linear-gradient(145deg, #444, #222);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      text-align: center;
      border: 3px solid var(--gold);
      max-width: 560px;
      width: 100%;
    }
    .title {
      font-size: 2rem;
      color: var(--gold);
      margin-bottom: 18px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      font-weight: bold;
    }
    .status {
      min-height: 44px;
      font-size: 1.1rem;
      margin: 10px 0 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .slots-container {
      display: flex;
      justify-content: center;
      gap: 14px;
      margin: 18px 0 8px;
      background: #111;
      padding: 16px;
      border-radius: 15px;
      border: 3px solid var(--gold);
    }
    .slot {
      width: 92px;
      height: 110px;
      background: #333;
      border: 3px solid #555;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      font-weight: bold;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 4px 8px rgba(0,0,0,0.3);
      color: #fff;
    }
    .slot.spinning {
      animation: fastSpin 0.1s linear infinite;
    }
    .slot.win {
      background: linear-gradient(145deg, #4caf50, #2e7d32);
      box-shadow: 0 0 20px #4caf50;
    }
    .slot.lose {
      background: linear-gradient(145deg, #f44336, #c62828);
    }
    @keyframes fastSpin {
      0%   { transform: rotateY(0)   scale(1.06); }
      50%  { transform: rotateY(180deg) scale(1.06); }
      100% { transform: rotateY(360deg) scale(1.06); }
    }
    .spin-button {
      background: linear-gradient(145deg, var(--gold), #ffa000);
      border: none;
      border-radius: 50%;
      width: 110px;
      height: 110px;
      font-size: 1.1rem;
      font-weight: bold;
      color: #333;
      cursor: pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
      margin: 10px auto 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .spin-button:hover { transform: translateY(-2px); }
    .spin-button:active { transform: translateY(0); }
    .spin-button:disabled {
      background: #666;
      color: #ddd;
      cursor: not-allowed;
      box-shadow: none;
    }
    .win-box {
      margin-top: 12px;
      padding: 12px;
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--gold);
      border-radius: 10px;
      display: none;
    }
    .win-box h3 {
      margin: 0 0 8px 0;
      color: var(--gold);
    }
    .qr-wrap {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    .qr-note {
      font-size: 0.95rem;
      opacity: 0.9;
    }
    .paramount-ad {
      margin-top: 18px;
      text-align: center;
    }
    .paramount-ad img {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .tiny {
      opacity: 0.85;
      font-size: 0.85rem;
      margin-top: 8px;
    }
    @media (max-width: 420px) {
      .slot { width: 82px; height: 100px; font-size: 1.4rem; }
      .spin-button { width: 100px; height: 100px; }
    }
  </style>
</head>
<body>
  <div class="slot-machine">
    <h1 class="title">Coffee Spin</h1>

    <div id="status" class="status">Loading token‚Ä¶</div>

    <div class="slots-container">
      <div class="slot" id="slot1">‚òï</div>
      <div class="slot" id="slot2">üé∞</div>
      <div class="slot" id="slot3">‚≠ê</div>
    </div>

    <button class="spin-button" id="spinButton" disabled>SPIN</button>

    <!-- Winner reveal / QR -->
    <div id="winBox" class="win-box">
      <h3>üéâ Winner! Free coffee</h3>
      <div class="qr-wrap">
        <canvas id="qrCanvas" width="120" height="120"></canvas>
        <div class="qr-note">
          Show this to the barista to redeem.<br/>
          Token: <span id="tokenText"></span><br/>
          <a id="verifyLink" href="#" style="color:#ffd700;text-decoration:underline;">Open verify page</a>
        </div>
      </div>
      <div class="tiny">Scanning the QR marks this token as redeemed.</div>
    </div>

    <div class="paramount-ad">
      <a href="https://www.paramountplus.com/au/?gclid=a2d84b86af821a952a2523136b29fa69&gclsrc=3p.ds&&ftag=IPP-07-10djc8i&vndid=&msclkid=a2d84b86af821a952a2523136b29fa69"
         target="_blank" rel="noopener">
        <img src="assets/paramountplusad.png" alt="Paramount+ Advertisement">
      </a>
    </div>

    <audio id="spinAudio" preload="auto">
      <source src="assets/spin.mp3" type="audio/mpeg" />
    </audio>
    <audio id="winnerAudio" preload="auto">
      <source src="assets/winner.mp3" type="audio/mpeg" />
    </audio>
  </div>

  <!-- QR code generator -->
  <script src="assets/qrious.min.js"></script>

  <script>
    // ======= CONFIG =======
    // If this page is served on a different domain than your backend, set API_BASE to your Render URL.
    // Otherwise it will default to same-origin.
    const DEFAULT_API_BASE = window.location.origin;
    const RENDER_API_BASE  = 'https://coffescratch.onrender.com';
    // Choose one automatically: if this page is opened as a file or on a different host, use Render.
    const API_BASE = (location.protocol === 'file:' || !location.host.includes('coffescratch'))
      ? RENDER_API_BASE
      : DEFAULT_API_BASE;

    const slots = [
      document.getElementById('slot1'),
      document.getElementById('slot2'),
      document.getElementById('slot3')
    ];
    const spinBtn    = document.getElementById('spinButton');
    const statusEl   = document.getElementById('status');
    const spinAudio  = document.getElementById('spinAudio');
    const winAudio   = document.getElementById('winnerAudio');
    const winBox     = document.getElementById('winBox');
    const qrCanvas   = document.getElementById('qrCanvas');
    const tokenText  = document.getElementById('tokenText');
    const verifyLink = document.getElementById('verifyLink');

    let isSpinning = false;
    let token = null;
    let tokenResult = null; // 'win' or 'lose'

    // Load token from query, fetch outcome from backend
    async function init() {
      const params = new URLSearchParams(window.location.search);
      token = params.get('token');

      if (!token) {
        statusEl.textContent = '‚ùå Missing token in URL.';
        return;
      }

      statusEl.textContent = 'Checking token‚Ä¶';

      try {
        const res = await fetch(`${API_BASE}/api/token/${encodeURIComponent(token)}`);
        if (!res.ok) throw new Error('Token not found');
        const data = await res.json();

        if (!data.valid) {
          statusEl.textContent = '‚ùå Invalid or expired token.';
          return;
        }

        tokenResult = data.result; // 'win' or 'lose'
        statusEl.textContent = 'Ready. Tap SPIN.';
        spinBtn.disabled = false;

      } catch (e) {
        statusEl.textContent = '‚ùå Error contacting server.';
        console.error(e);
      }
    }

    function startSpin() {
      if (isSpinning || !tokenResult) return;
      isSpinning = true;
      spinBtn.disabled = true;
      statusEl.textContent = 'Spinning‚Ä¶';

      // Start sound (ignore autoplay errors quietly)
      try { spinAudio.currentTime = 0; spinAudio.play(); } catch {}

      // Visual spin
      slots.forEach(s => {
        s.classList.remove('win','lose');
        s.classList.add('spinning');
        s.textContent = ' ';
      });

      // Fake rolling glyphs while spinning
      const glyphs = ['‚òï','üí´','‚≠ê','üé∞','üé≤','üçÄ'];
      const interval = setInterval(() => {
        slots.forEach(s => s.textContent = glyphs[Math.floor(Math.random()*glyphs.length)]);
      }, 60);

      // After 1.8s, stop with result forced by backend
      setTimeout(() => {
        clearInterval(interval);
        const final = (tokenResult === 'win')
          ? ['WIN','WIN','WIN']
          : ['LOSE','LOSE','LOSE'];

        slots.forEach((s, i) => {
          s.classList.remove('spinning');
          s.textContent = final[i];
          s.classList.add(tokenResult === 'win' ? 'win' : 'lose');
        });

        // Reveal win extras
        if (tokenResult === 'win') {
          statusEl.innerHTML = 'üéâ Winner! Show the QR to the barista.';
          try { winAudio.currentTime = 0; winAudio.play(); } catch {}

          // Build verify link (same backend domain)
          const verifyURL = `${API_BASE}/verify.html?token=${encodeURIComponent(token)}`;
          verifyLink.href = verifyURL;
          tokenText.textContent = token;

          // Render QR pointing to verify page
          new QRious({
            element: qrCanvas,
            size: 120,
            value: verifyURL
          });

          winBox.style.display = 'block';
        } else {
          statusEl.textContent = 'üò¢ Not a winner this time.';
          winBox.style.display = 'none';
        }

        // Re-enable spin (if you want single-use only, keep disabled)
        setTimeout(() => {
          isSpinning = false;
          // spinBtn.disabled = false; // keep disabled to prevent repeated spins
        }, 800);
      }, 1800);
    }

    spinBtn.addEventListener('click', startSpin);
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
