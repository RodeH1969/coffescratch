<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Coffee Spin</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚òï</text></svg>">
  <style>
    :root { --gold: #ffd700; }
    body {
      margin: 0; padding: 20px;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      font-family: Arial, sans-serif;
      display: flex; justify-content: center; align-items: flex-start;
      min-height: 100vh; color: #fff;
    }
    .slot-machine {
      background: linear-gradient(145deg, #444, #222);
      border-radius: 20px; padding: 24px; text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border: 3px solid var(--gold);
      max-width: 560px; width: 100%;
      margin-top: 20px;
    }
    .logo {
      width: 180px;  /* 25% smaller */
      max-width: 70%;
      height: auto;
      display: block;
      margin: 0 auto 10px auto;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.45));
    }

    .status { min-height: 24px; font-size: 1.05rem; margin: 6px 0; }

    .slots-container {
      display: flex; justify-content: center; gap: 14px;
      margin: 8px 0; background: #111; padding: 12px;
      border-radius: 15px; border: 3px solid var(--gold); position: relative;
    }
    .slot {
      width: 92px; height: 110px; background: #333;
      border: 3px solid #555; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
      box-shadow: inset 0 4px 8px rgba(0,0,0,0.3);
    }
    .slot img {
      width: 100%; height: 100%; object-fit: cover;
      transform-origin: center;
      will-change: contents;
      user-select: none;
      pointer-events: none;
    }

    /* Final icon replaces ads after spin */
    .final-icon {
      position: absolute;
      inset: 0;
      display: none;
      object-fit: contain;
      width: 80%;
      height: 80%;
      margin: auto;
      padding: 6px;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
    }

    /* Capsule spin button */
    .spin-button {
      background: linear-gradient(145deg, var(--gold), #ffa000);
      border: none; border-radius: 999px;
      width: 180px; height: 60px;
      font-size: 1.1rem; font-weight: bold; color: #333; cursor: pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3); transition: all 0.2s ease;
      margin: 14px auto 6px; display: inline-flex; align-items: center; justify-content: center;
    }
    .spin-button:hover { transform: translateY(-2px); }
    .spin-button:active { transform: translateY(0); }
    .spin-button:disabled { background: #666; color: #ddd; cursor: not-allowed; box-shadow: none; }

    .win-box {
      margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.4);
      border: 1px solid var(--gold); border-radius: 10px; display: none;
    }
    .win-box h3 { margin: 0 0 8px 0; color: var(--gold); }
    .qr-wrap { display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap; }
    .qr-note { font-size: 0.95rem; opacity: 0.9; }

    .save-notice {
      background: rgba(255,215,0,0.1); 
      padding: 10px; 
      border-radius: 8px; 
      margin: 10px 0;
      border: 1px solid var(--gold);
    }

    .download-btn {
      background: var(--gold); 
      color: #333; 
      border: none; 
      padding: 12px 20px; 
      border-radius: 8px; 
      font-weight: bold; 
      margin: 10px; 
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .download-btn:hover { transform: translateY(-1px); }

    .paramount-ad { margin-top: 18px; text-align: center; }
    .paramount-ad img {
      max-width: 100%; height: auto; border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .tiny { opacity: 0.85; font-size: 0.9rem; margin-top: 8px; }

    @media (max-width: 420px) {
      body { align-items: flex-start; padding-top: 5px; }
      .slot-machine { margin-top: 5px; }
      .slot { width: 82px; height: 100px; }
      .spin-button { width: 160px; height: 55px; }
      .logo { width: 150px; }
    }
  </style>
</head>
<body>
  <div class="slot-machine">
    <img class="logo" src="assets/coffeespinlogo.png" alt="Coffee Spin Logo" />

    <div id="status" class="status"></div>

    <div class="slots-container">
      <div class="slot" id="slot1">
        <img id="img1" src="assets/ad2A.png" alt="Ad 1">
        <img id="finalIco1" class="final-icon" alt="Result 1" />
      </div>
      <div class="slot" id="slot2">
        <img id="img2" src="assets/ad2B.png" alt="Ad 2">
        <img id="finalIco2" class="final-icon" alt="Result 2" />
      </div>
      <div class="slot" id="slot3">
        <img id="img3" src="assets/ad2C.png" alt="Ad 3">
        <img id="finalIco3" class="final-icon" alt="Result 3" />
      </div>
    </div>

    <button class="spin-button" id="spinButton" disabled>SPIN</button>

    <!-- Winner reveal / QR -->
    <div id="winBox" class="win-box">
      <h3>üéâ Winner! Free coffee awaits!</h3>
      
      <div class="save-notice">
        <strong>üì± SAVE THIS NOW:</strong><br/>
        Screenshot this page or use the download button below
      </div>
      
      <div class="qr-wrap">
        <canvas id="qrCanvas" width="120" height="120" style="display:none;"></canvas>
        <div class="qr-note">
          üéüÔ∏è Your winning token: <strong><span id="tokenText"></span></strong><br/>
          <span id="qrFallback" class="tiny" style="display:none;">(QR not available ‚Äî show this token to barista)</span>
        </div>
      </div>
      
      <button id="downloadBtn" class="download-btn" style="display:none;">
        üì± Download QR Code
      </button>
      
      <div class="tiny">Show this QR code OR token number to your barista for free coffee!</div>
    </div>

    <div class="sponsor-ad">
  <a href="https://www.comparethemarket.com.au"
     target="_blank" rel="noopener">
    <img src="assets/comparead.png" alt="Compare Advertisement">
  </a>
</div>

    <audio id="spinAudio" preload="auto">
      <source src="assets/spin.mp3" type="audio/mpeg" />
    </audio>
    <audio id="winnerAudio" preload="auto">
      <source src="assets/winner.mp3" type="audio/mpeg" />
    </audio>
  </div>

  <!-- QR lib (fallback-safe) -->
  <script src="/assets/qrious.min.js"></script>

  <script>
    const API_BASE = window.location.origin;

    // Elements
    const imgEls     = [document.getElementById('img1'), document.getElementById('img2'), document.getElementById('img3')];
    const finalIcons = [document.getElementById('finalIco1'), document.getElementById('finalIco2'), document.getElementById('finalIco3')];
    const spinBtn    = document.getElementById('spinButton');
    const statusEl   = document.getElementById('status');
    const spinSnd    = document.getElementById('spinAudio');
    const winSnd     = document.getElementById('winnerAudio');
    const winBox     = document.getElementById('winBox');
    const qrCanvas   = document.getElementById('qrCanvas');
    const tokenText  = document.getElementById('tokenText');
    const qrFallback = document.getElementById('qrFallback');
    const downloadBtn = document.getElementById('downloadBtn');

    // Reel frames (ads)
    const FRAMES = ["assets/ad1.png", "assets/ad2.png", "assets/ad3.png"];

    // State
    let token = null;
    let tokenResult = null; // 'win' | 'lose'
    let isSpinning = false;
    let qrInstance = null;

    // Preload images to avoid flicker
    function preload(srcs) {
      srcs.forEach(s => { const i = new Image(); i.src = s; });
    }
    preload(FRAMES.concat(["assets/tick.png","assets/cross.png"]));

    // Download QR code as image
    function downloadQRCode() {
      try {
        const link = document.createElement('a');
        link.download = `coffee-winner-${token}.png`;
        link.href = qrCanvas.toDataURL();
        link.click();
      } catch (error) {
        alert('Download failed. Please take a screenshot instead.');
      }
    }

    // Easing + dynamic FPS spinner that never "sticks"
    function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }
    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
    function lerp(a, b, t) { return a + (b - a) * t; }

    /**
     * Spin a reel by cycling its <img> through FRAMES at a dynamic FPS.
     * Uses an accumulator so frames advance reliably (no stalls at slow speeds).
     */
    function spinReel(imgEl, durationMs, startDelayMs = 0) {
      return new Promise(resolve => {
        const startAt = performance.now() + startDelayMs;
        let rafId = null;
        let lastTime = 0;
        let acc = 0;
        let frameIdx = 0;

        function loop(now) {
          if (now < startAt) { rafId = requestAnimationFrame(loop); return; }

          if (!lastTime) lastTime = now;
          const elapsedTotal = now - startAt;
          const dt = now - lastTime;
          lastTime = now;

          const t = clamp(elapsedTotal / durationMs, 0, 1);
          // FPS decelerates from 40 ‚Üí 10 using easeOut
          const fps = lerp(40, 10, easeOutCubic(t));
          const frameDelay = 1000 / fps;

          acc += dt;
          while (acc >= frameDelay) {
            acc -= frameDelay;
            frameIdx = (frameIdx + 1) % FRAMES.length;
            imgEl.src = FRAMES[frameIdx];
          }

          if (elapsedTotal < durationMs) {
            rafId = requestAnimationFrame(loop);
          } else {
            if (rafId) cancelAnimationFrame(rafId);
            resolve();
          }
        }

        rafId = requestAnimationFrame(loop);
      });
    }

    function revealFinals(isWin) {
      // Hide spinning images, show tick/cross overlay on all three
      imgEls.forEach(img => { img.style.display = 'none'; });
      const src = isWin ? 'assets/tick.png' : 'assets/cross.png';
      finalIcons.forEach(el => { el.src = src; el.style.display = 'block'; });
    }

    async function startSpin() {
      if (isSpinning || !tokenResult) return;
      isSpinning = true;
      spinBtn.disabled = true;
      statusEl.textContent = '';

      try { spinSnd.currentTime = 0; spinSnd.play(); } catch {}

      // Ensure ads visible, finals hidden during spin
      imgEls.forEach(img => { img.style.display = 'block'; });
      finalIcons.forEach(el => { el.style.display = 'none'; });

      // Staggered reel durations (tuned to feel smooth + quick)
      await Promise.all([
        spinReel(imgEls[0], 1200, 0),
        spinReel(imgEls[1], 1500, 80),
        spinReel(imgEls[2], 1800, 160),
      ]);

      try { spinSnd.pause(); spinSnd.currentTime = 0; } catch {}

      const isWin = (tokenResult === 'win');
      revealFinals(isWin);

      if (isWin) {
        try { winSnd.currentTime = 0; winSnd.play(); } catch {}
        tokenText.textContent = token;

        const verifyURL = `${API_BASE}/verify.html?token=${encodeURIComponent(token)}`;
        if (window.QRious) {
          qrInstance = new QRious({ element: qrCanvas, size: 120, value: verifyURL });
          qrCanvas.style.display = 'block';
          downloadBtn.style.display = 'inline-block';
          qrFallback.style.display = 'none';
        } else {
          qrCanvas.style.display = 'none';
          downloadBtn.style.display = 'none';
          qrFallback.style.display = 'inline';
        }
        winBox.style.display = 'block';
      } else {
        winBox.style.display = 'none';
        statusEl.textContent = 'Oh shucks, not a winner today. Come back soon for another spin!';
      }

      isSpinning = false;
    }

    async function init() {
      const params = new URLSearchParams(window.location.search);
      token = params.get('token');
      if (!token) { statusEl.textContent = '‚ùå Missing token in URL.'; return; }

      statusEl.textContent = '';
      try {
        const res = await fetch(`${API_BASE}/api/token/${encodeURIComponent(token)}`);
        if (!res.ok) throw new Error('Token not found');
        const data = await res.json();
        if (!data.valid) { statusEl.textContent = '‚ùå Invalid or expired token.'; return; }
        tokenResult = data.result;
        spinBtn.disabled = false;
      } catch (e) {
        statusEl.textContent = '‚ùå Error contacting server.';
      }
    }

    spinBtn.addEventListener('click', startSpin);
    downloadBtn.addEventListener('click', downloadQRCode);
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>